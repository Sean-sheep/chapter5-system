# 系统整体逻辑与架构设计（待确认）

> **说明**：本文档明确系统双线逻辑（训练过程展示 vs 用户推荐使用）、数据来源、页面划分与创新点对应关系。**确认本方案后再进行代码实现。**

---

## 一、设计目标与创新点对应关系

### 1.1 系统要体现的论文章节创新

| 章节 | 创新点概要 | 在系统中的体现方式 |
|------|------------|--------------------|
| **第三章** | 基于混合模型的重要度自适应压缩的个性化联邦学习 | ① 通信开销低（Top-k + 残差反馈）<br>② 个性化（多子模型 + 客户端混合权重 γ） |
| **第四章** | 基于自适应本地迭代的差分隐私机制 | ① 聚合时本地迭代次数 τ* 动态变化<br>② 可选：隐私预算/效用权衡等 |

### 1.2 两条展示主线（核心逻辑）

系统分为两条主线，**数据来源不同**，**展示目的不同**：

```
┌─────────────────────────────────────────────────────────────────────────┐
│  主线一：训练过程展示（证明“通信低、τ* 动态、隐私”等创新）              │
│  数据来源：训练过程产生的日志 / 统计文件                                │
│  展示对象：研究者、答辩委员（看算法效果与过程）                          │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│  主线二：用户推荐使用（证明“个性化推荐更精准”创新）                     │
│  数据来源：训练完成后的模型参数（推理时加载，不做训练）                  │
│  展示对象：模拟“用户”选城市、看推荐消费品，体验个性化差异               │
└─────────────────────────────────────────────────────────────────────────┘
```

- **训练过程展示**：所有用于“证明创新点”的**参数与曲线**（通信量、压缩比例、τ*、隐私预算等）均来自**训练日志**，系统只读取、聚合、可视化，不参与训练计算。
- **用户推荐使用**：展示“**被推荐消费品**”的页面，使用**已训练好的个性化模型**做前向推理，通过不同城市推荐结果差异体现**个性化更精准**。

---

## 二、数据来源定义（关键约定）

### 2.1 训练过程展示 → 依赖“训练日志”

以下数据**必须由您的训练代码在训练过程中写入**，本系统只负责读取与展示：

| 用途 | 建议日志内容/文件 | 说明 |
|------|-------------------|------|
| 通信开销低（第三章） | 每轮/每客户端的：原始参数量或通信量、压缩后参数量/通信量、压缩比例；可选：Top-k 比例、是否残差反馈 | 用于画“通信量/压缩比例”曲线、统计表 |
| τ* 动态变化（第四章） | 每轮、每客户端的**本地迭代次数 τ***（即本轮实际执行的本地迭代数） | 用于画“τ* 随轮次/客户端”变化曲线 |
| 个性化机制（第三章） | 每轮、每客户端的**混合权重 γ**（对各子模型的权重） | 用于画“γ 随轮次/客户端”分布或变化 |
| 差分隐私（第四章，可选） | 每轮/累计的隐私预算 ε 消耗、裁剪阈值、噪声尺度等 | 若有实验，可做隐私–效用展示 |
| 评估指标（辅助） | 每轮或阶段性的 HR@K、NDCG@K、RMSE 等（可按客户端或全局） | 用于训练过程展示页的“效果随训练”曲线 |

**本系统不做的事**：不运行训练、不计算梯度、不聚合模型；只读取上述日志/统计文件（如 JSON、CSV、PKL 等），做聚合、计算比例、画图。

### 2.2 用户推荐使用 → 依赖“训练好的模型”

| 用途 | 数据来源 | 说明 |
|------|----------|------|
| 个性化推荐列表 | 各客户端（城市）对应的**个性化模型**或「子模型 + γ」可还原的模型 | 系统加载后做前向推理，得到 Top-K 推荐 |
| 商品/用户信息 | 与训练时一致的商品 ID、可选：商品名称等（用于展示“消费品”） | 仅用于展示推荐结果 |

---

## 三、系统整体架构（双线 + 数据流）

### 3.1 顶层结构

```
                    ┌──────────────────────────────────────┐
                    │         前端展示层 (Streamlit)        │
                    │  ┌─────────────────────────────────┐ │
                    │  │  训练过程展示区  │  用户推荐使用区 │ │
                    │  │  (日志驱动)     │  (模型推理)     │ │
                    │  └─────────────────────────────────┘ │
                    └──────────────────────────────────────┘
            ┌───────────────────────────┼───────────────────────────┐
            ▼                           ▼                           ▼
   ┌─────────────────┐       ┌─────────────────┐       ┌─────────────────┐
   │ 训练日志读取与   │       │ 模型结果读取与   │       │ 业务场景映射     │
   │ 统计/曲线生成   │       │ 推理服务         │       │ (城市↔客户端)   │
   └─────────────────┘       └─────────────────┘       └─────────────────┘
            │                           │                           │
            ▼                           ▼                           ▼
   ┌─────────────────┐       ┌─────────────────┐       ┌─────────────────┐
   │ 训练日志/统计   │       │ 模型参数文件     │       │ 城市–客户端配置  │
   │ 文件（磁盘）    │       │ （磁盘）         │       │ （内置或配置）   │
   └─────────────────┘       └─────────────────┘       └─────────────────┘
```

### 3.2 数据流

- **训练过程展示**：`训练日志文件` → `日志读取/解析` → `统计与曲线数据` → `训练过程展示页面`
- **用户推荐使用**：`模型文件` + `城市→客户端` → `加载个性化模型` → `前向推理` → `推荐结果` → `用户推荐使用页面`

---

## 四、功能模块划分（与双线对应）

| 模块 | 归属主线 | 数据来源 | 职责 |
|------|----------|----------|------|
| **训练日志加载器** | 训练过程展示 | 训练日志 | 读取通信、τ*、γ、隐私等日志，提供按轮次/客户端聚合数据 |
| **通信分析模块** | 训练过程展示 | 训练日志 | 计算压缩比例、通信量曲线、统计表 |
| **自适应迭代展示模块** | 训练过程展示 | 训练日志 | 读取 τ* 轨迹，生成 τ* 随轮次/客户端变化曲线 |
| **个性化权重分析模块** | 训练过程展示 | 训练日志（γ） | 展示 γ 分布、随轮次变化 |
| **模型加载器** | 用户推荐使用 | 模型参数文件 | 加载子模型、γ 或个性化模型，供推理使用 |
| **推荐推理服务** | 用户推荐使用 | 模型 + 城市映射 | 按城市→客户端加载模型，前向推理，返回 Top-K |
| **业务场景映射** | 用户推荐使用 | 配置 | 城市 ↔ 客户端 ID |

---

## 五、页面划分与创新点对应

### 5.1 训练过程展示区（数据来自训练日志）

| 页面 | 对应创新点 | 展示内容 |
|------|------------|----------|
| **通信与压缩效果** | 第三章：通信开销低 | 压缩比例随轮次曲线、通信量对比、统计表 |
| **自适应迭代 τ* 轨迹** | 第四章：τ* 动态变化 | τ* 随轮次/客户端曲线、统计 |
| **个性化权重 γ 分析** | 第三章：混合模型+γ | γ 分布柱状图、γ 随轮次变化 |
| **隐私与效用（可选）** | 第四章：差分隐私 | ε 消耗、隐私–效用曲线 |

### 5.2 用户推荐使用区（数据来自模型推理）

| 页面 | 对应创新点 | 展示内容 |
|------|------------|----------|
| **按城市推荐（消费品）** | 第三章：个性化更精准 | 选城市→展示该城市 Top-K 推荐消费品列表 |
| **多城市推荐对比** | 第三章：个性化差异 | 同一用户、多城市推荐结果对比 |

### 5.3 首页与导航

- **首页**：系统标题、两条入口：「训练过程展示」「用户推荐使用」。
- **导航**：侧边栏或 Tab 区分上述两大区，其下再分具体子页。

---

## 六、训练日志接口约定（最小约定）

### 6.1 通信与压缩（第三章）

- 建议字段（按轮次，可选按客户端）：`round`, `client_id`, `original_size`, `compressed_size`, `compression_ratio`

### 6.2 自适应本地迭代 τ*（第四章）

- 建议字段：`round`, `client_id`, `tau_star`

### 6.3 个性化权重 γ（第三章）

- 建议字段：`round`, `client_id`, `gamma`（列表或字典）

### 6.4 模型

- 按您现有格式保存子模型或个性化模型，本系统按约定路径读取并推理。

---

## 七、待您确认的要点

1. **双线划分**：是否同意系统严格分为「训练过程展示」（日志驱动）与「用户推荐使用」（模型推理）两条主线？
2. **页面划分**：训练过程展示下包含：通信与压缩、τ* 轨迹、γ 分析、（可选）隐私；用户推荐使用下包含：按城市推荐、多城市对比；是否需增删？
3. **日志格式**：上述训练日志的字段/文件名是否与您当前或计划中的训练输出一致？若不一致，请列出您已有或计划输出的字段与文件结构。
4. **第四章展示**：除 τ* 外，是否需要在系统里展示“隐私预算/效用”等？若需要，请说明会输出哪些隐私相关字段。

**确认本方案后，再进入代码实现阶段。**
