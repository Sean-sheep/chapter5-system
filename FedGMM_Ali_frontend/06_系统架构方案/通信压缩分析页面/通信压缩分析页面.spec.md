# 通信压缩分析页面 SPEC 文档

## 1. 页面功能描述

### 1.1 核心功能

- **压缩比例分析**：展示通信压缩比例随轮次的变化趋势
- **通信量统计**：展示原始通信量、压缩后通信量、节省量等统计数据
- **客户端分析**：支持按客户端查看通信压缩效果
- **统计摘要**：展示总轮次、平均压缩比例、总节省量、节省百分比等关键指标

### 1.2 辅助功能

- **数据导出**：支持导出通信统计数据为CSV格式
- **图表交互**：支持图表缩放、数据点悬停查看详情

## 2. 交互流程

### 2.1 页面加载流程

1. **初始化**：页面加载时，初始化通信分析服务和数据状态
2. **参数设置**：显示默认参数设置（客户端选择、轮次范围）
3. **数据加载**：加载通信统计数据，准备分析

### 2.2 数据分析流程

1. **参数配置**：用户选择客户端（全部/指定）、设置轮次范围
2. **提交请求**：用户点击"刷新数据"按钮
3. **数据处理**：系统加载并处理通信统计数据
4. **图表生成**：生成压缩比例随轮次变化的图表
5. **统计计算**：计算统计摘要指标
6. **结果展示**：显示图表、统计表和统计摘要

## 3. 数据字段定义

### 3.1 输入数据

| 字段名 | 类型 | 描述 | 来源 |
|--------|------|------|------|
| `client_id` | int/string | 选择的客户端（全部/指定） | 用户输入 |
| `round_range` | tuple | 轮次范围 (start, end) | 用户输入 |

### 3.2 输出数据

| 字段名 | 类型 | 描述 | 用途 |
|--------|------|------|------|
| `compression_data` | pd.DataFrame | 压缩比例数据 | 生成图表和统计表 |
| `statistics` | dict | 统计摘要指标 | 展示关键指标 |
| `chart` | plotly.Figure | 压缩比例图表 | 可视化展示 |

### 3.3 通信统计数据结构

```json
{
  "round": 1,
  "client_id": 0,
  "original_size": 1000000,
  "compressed_size": 200000,
  "compression_ratio": 0.2,
  "savings": 800000,
  "savings_percentage": 80
}
```

## 4. 接口调用规范

### 4.1 内部接口

| 接口名 | 参数 | 返回值 | 功能描述 | 调用时机 |
|--------|------|--------|----------|----------|
| `CommunicationAnalyzer.calculate_compression_ratio` | `client_id: int = None, round_range: tuple = None` | `pd.DataFrame` | 计算压缩比例 | 点击"刷新数据"按钮 |
| `CommunicationAnalyzer.plot_compression_ratio` | `client_id: int = None, round_range: tuple = None` | `plotly.Figure` | 生成压缩比例图表 | 数据加载后 |
| `CommunicationAnalyzer.generate_communication_report` | `client_id: int = None, round_range: tuple = None` | `dict` | 生成通信统计报告 | 数据加载后 |
| `ModelLoader.load_communication_stats` | `client_id: int = None, round_range: tuple = None` | `pd.DataFrame` | 加载通信统计数据 | 页面初始化 |

### 4.2 外部依赖

| 依赖项 | 类型 | 用途 | 调用时机 |
|--------|------|------|----------|
| `communication/` 目录 | 目录 | 存储通信统计数据 | 数据加载时 |
| `city_client_map.json` | 配置文件 | 城市-客户端映射 | 客户端名称显示 |

## 5. 异常处理机制

### 5.1 异常类型

| 异常类型 | 描述 | 处理方式 |
|----------|------|----------|
| **数据文件缺失** | 通信统计数据文件不存在 | 显示错误信息，提示用户检查数据文件 |
| **数据格式错误** | 通信统计数据格式错误 | 显示警告信息，尝试解析可用数据 |
| **参数错误** | 用户输入参数无效（如轮次范围错误） | 显示警告信息，提示用户修正参数 |
| **计算失败** | 统计计算过程中出现错误 | 显示错误信息，记录错误日志 |

### 5.2 错误提示

- **数据文件缺失**：`st.error("通信统计数据文件不存在，请检查 data/communication/ 目录")`
- **数据格式错误**：`st.warning("通信统计数据格式错误，尝试解析可用数据")`
- **参数错误**：`st.warning("无效的轮次范围，请检查输入")`
- **计算失败**：`st.error("统计计算失败，请检查数据文件")`

## 6. 性能要求

### 6.1 加载性能

- **页面加载时间**：≤ 3秒
- **数据加载时间**：≤ 2秒

### 6.2 交互性能

- **数据处理时间**：≤ 1秒（标准轮次范围）
- **图表渲染时间**：≤ 1秒
- **响应时间**：用户操作后，≤ 0.5秒内显示反馈

### 6.3 资源使用

- **内存使用**：≤ 150MB
- **CPU 使用率**：≤ 15%

## 7. 页面布局与组件

### 7.1 布局结构

- **侧边栏**：参数配置区（客户端选择、轮次范围、刷新数据按钮）
- **主区**：
  - 压缩比例图表区
  - 通信统计表区
  - 统计摘要指标卡区
  - 导出按钮区

### 7.2 核心组件

| 组件名 | 类型 | 描述 | 位置 |
|--------|------|------|------|
| `st.sidebar.selectbox` | 选择组件 | 客户端选择 | 侧边栏 |
| `st.sidebar.slider` | 滑块组件 | 轮次范围设置 | 侧边栏 |
| `st.sidebar.button` | 按钮组件 | 刷新数据按钮 | 侧边栏 |
| `st.plotly_chart` | 图表组件 | 压缩比例图表 | 主区顶部 |
| `st.dataframe` | 表格组件 | 通信统计表 | 主区中部 |
| `st.columns` | 布局组件 | 统计摘要指标卡 | 主区中部 |
| `st.download_button` | 按钮组件 | 导出数据按钮 | 主区底部 |

### 7.3 组件配置

- **客户端选择**：`st.sidebar.selectbox("客户端选择", ["全部", "Tokyo", "Osaka", "Nagoya"])`
- **轮次范围**：`st.sidebar.slider("轮次范围", 0, max_round, (0, max_round))`
- **压缩比例图表**：`st.plotly_chart(chart, use_container_width=True)`
- **通信统计表**：`st.dataframe(compression_data, use_container_width=True, height=400)`
- **统计摘要指标卡**：使用 `st.columns(4)` 创建四个指标卡

## 8. 实现注意事项

### 8.1 数据管理

- **缓存机制**：实现数据缓存，避免重复加载相同数据
- **数据验证**：验证数据格式和完整性，确保分析结果准确

### 8.2 性能优化

- **数据采样**：轮次范围较大时，使用数据采样减少计算量
- **异步处理**：使用异步处理数据，避免阻塞UI线程

### 8.3 图表设计

- **图表配置**：优化图表配置，确保视觉效果清晰
- **交互功能**：启用图表交互功能，提升用户体验
- **响应式设计**：确保图表在不同屏幕尺寸下都能正常显示

## 9. 测试要点

### 9.1 功能测试

- **数据加载**：验证通信统计数据加载是否正确
- **图表生成**：验证压缩比例图表是否正确生成
- **统计计算**：验证统计摘要指标计算是否准确
- **客户端筛选**：验证按客户端筛选功能是否正常
- **轮次范围**：验证不同轮次范围的分析结果是否正确

### 9.2 异常测试

- **数据缺失**：测试通信统计数据缺失时的错误处理
- **数据格式错误**：测试通信统计数据格式错误时的处理
- **参数错误**：测试无效轮次范围的处理

### 9.3 性能测试

- **数据加载性能**：测试不同大小通信统计数据的加载时间
- **图表渲染性能**：测试不同轮次范围的图表渲染时间
- **响应性能**：测试用户操作的响应时间

## 10. 版本控制

| 版本 | 日期 | 作者 | 变更内容 |
|------|------|------|----------|
| v1.0 | 2026-02-13 | 系统架构师 | 初始版本 |