# 个性化权重分析页面 SPEC 文档

## 1. 页面功能描述

### 1.1 核心功能

- **γ 权重分布展示**：展示不同城市/客户端的个性化权重 γ 分布
- **权重趋势分析**：展示 γ 权重随轮次的变化趋势
- **多客户端对比**：支持对比多个客户端的 γ 权重差异
- **权重差异计算**：计算不同客户端间的权重差异（如 L2 距离）

### 1.2 辅助功能

- **数据导出**：支持导出 γ 权重数据为CSV格式
- **图表交互**：支持图表缩放、数据点悬停查看详情

## 2. 交互流程

### 2.1 页面加载流程

1. **初始化**：页面加载时，初始化个性化权重分析服务和数据状态
2. **参数设置**：显示默认参数设置（训练轮次、城市选择）
3. **数据加载**：加载 γ 权重数据，准备分析

### 2.2 数据分析流程

1. **参数配置**：用户选择训练轮次、选择城市（全部/指定）
2. **提交请求**：用户点击"刷新数据"按钮
3. **数据处理**：系统加载并处理 γ 权重数据
4. **图表生成**：生成 γ 权重分布图表和趋势图表
5. **差异计算**：计算不同客户端间的权重差异
6. **结果展示**：显示图表、权重对比表和差异分析

## 3. 数据字段定义

### 3.1 输入数据

| 字段名 | 类型 | 描述 | 来源 |
|--------|------|------|------|
| `round` | int | 选择的训练轮次 | 用户输入 |
| `client_ids` | list | 选择的客户端列表 | 用户输入 |
| `trend_client_id` | int | 趋势分析的客户端ID | 用户输入 |
| `trend_round_range` | tuple | 趋势分析的轮次范围 | 用户输入 |

### 3.2 输出数据

| 字段名 | 类型 | 描述 | 用途 |
|--------|------|------|------|
| `gamma_data` | pd.DataFrame | γ 权重数据 | 生成分布图和对比表 |
| `gamma_trend` | pd.DataFrame | γ 权重趋势数据 | 生成趋势图 |
| `gamma_comparison` | pd.DataFrame | γ 权重对比数据 | 展示客户端差异 |
| `distribution_chart` | plotly.Figure | γ 权重分布图表 | 可视化分布 |
| `trend_chart` | plotly.Figure | γ 权重趋势图表 | 可视化趋势 |

### 3.3 γ 权重数据结构

```json
{
  "round": 1,
  "client_id": 0,
  "gamma": [0.6, 0.3, 0.1]  // 各子模型的权重
}
```

## 4. 接口调用规范

### 4.1 内部接口

| 接口名 | 参数 | 返回值 | 功能描述 | 调用时机 |
|--------|------|--------|----------|----------|
| `PersonalizationWeightAnalyzer.load_gamma_data` | `client_ids: list = None, round: int = None` | `pd.DataFrame` | 加载 γ 数据 | 页面初始化 |
| `PersonalizationWeightAnalyzer.plot_gamma_distribution` | `client_ids: list = None, round: int = None` | `plotly.Figure` | 生成 γ 权重分布图表 | 数据加载后 |
| `PersonalizationWeightAnalyzer.plot_gamma_trend` | `client_id: int, round_range: tuple = None` | `plotly.Figure` | 生成 γ 权重趋势图表 | 数据加载后 |
| `PersonalizationWeightAnalyzer.compare_gamma` | `client_ids: list, round: int = None` | `pd.DataFrame` | 对比多个客户端的 γ 权重 | 数据加载后 |
| `ModelLoader.load_client_gamma` | `client_id: int, round: int` | `list` | 加载客户端 γ 权重 | 页面初始化 |

### 4.2 外部依赖

| 依赖项 | 类型 | 用途 | 调用时机 |
|--------|------|------|----------|
| `gamma/` 目录 | 目录 | 存储 γ 权重数据 | 数据加载时 |
| `city_client_map.json` | 配置文件 | 城市-客户端映射 | 客户端名称显示 |

## 5. 异常处理机制

### 5.1 异常类型

| 异常类型 | 描述 | 处理方式 |
|----------|------|----------|
| **数据文件缺失** | γ 权重数据文件不存在 | 显示错误信息，提示用户检查数据文件 |
| **数据格式错误** | γ 权重数据格式错误 | 显示警告信息，尝试解析可用数据 |
| **参数错误** | 用户输入参数无效（如轮次不存在） | 显示警告信息，提示用户修正参数 |
| **计算失败** | 权重差异计算过程中出现错误 | 显示错误信息，记录错误日志 |

### 5.2 错误提示

- **数据文件缺失**：`st.error("γ 权重数据文件不存在，请检查 data/gamma/ 目录")`
- **数据格式错误**：`st.warning("γ 权重数据格式错误，尝试解析可用数据")`
- **参数错误**：`st.warning("无效的轮次，请检查输入")`
- **计算失败**：`st.error("权重差异计算失败，请检查数据文件")`

## 6. 性能要求

### 6.1 加载性能

- **页面加载时间**：≤ 3秒
- **数据加载时间**：≤ 2秒

### 6.2 交互性能

- **数据处理时间**：≤ 1秒（标准轮次范围）
- **图表渲染时间**：≤ 1秒
- **响应时间**：用户操作后，≤ 0.5秒内显示反馈

### 6.3 资源使用

- **内存使用**：≤ 150MB
- **CPU 使用率**：≤ 15%

## 7. 页面布局与组件

### 7.1 布局结构

- **侧边栏**：参数配置区（训练轮次、城市选择、刷新数据按钮）
- **主区**：
  - γ 权重分布图表区
  - 权重对比表区
  - γ 权重趋势图表区（可选）
  - 导出按钮区

### 7.2 核心组件

| 组件名 | 类型 | 描述 | 位置 |
|--------|------|------|------|
| `st.sidebar.selectbox` | 选择组件 | 训练轮次选择 | 侧边栏 |
| `st.sidebar.selectbox` | 选择组件 | 城市选择（全部/指定） | 侧边栏 |
| `st.sidebar.button` | 按钮组件 | 刷新数据按钮 | 侧边栏 |
| `st.plotly_chart` | 图表组件 | γ 权重分布图表 | 主区顶部 |
| `st.dataframe` | 表格组件 | 权重对比表 | 主区中部 |
| `st.plotly_chart` | 图表组件 | γ 权重趋势图表 | 主区中部 |
| `st.download_button` | 按钮组件 | 导出数据按钮 | 主区底部 |

### 7.3 组件配置

- **训练轮次**：`st.sidebar.selectbox("训练轮次", ["最新"] + available_rounds)`
- **城市选择**：`st.sidebar.selectbox("城市选择", ["全部", "Tokyo", "Osaka", "Nagoya"])`
- **γ 权重分布图表**：`st.plotly_chart(distribution_chart, use_container_width=True)`
- **权重对比表**：`st.dataframe(gamma_comparison, use_container_width=True, height=400)`
- **γ 权重趋势图表**：`st.plotly_chart(trend_chart, use_container_width=True)`

## 8. 实现注意事项

### 8.1 数据管理

- **缓存机制**：实现数据缓存，避免重复加载相同数据
- **数据验证**：验证数据格式和完整性，确保分析结果准确

### 8.2 性能优化

- **数据采样**：轮次范围较大时，使用数据采样减少计算量
- **异步处理**：使用异步处理数据，避免阻塞UI线程

### 8.3 图表设计

- **分布图表**：使用分组柱状图展示不同客户端的权重分布
- **趋势图表**：使用折线图展示权重随轮次的变化
- **交互功能**：启用图表交互功能，提升用户体验

## 9. 测试要点

### 9.1 功能测试

- **数据加载**：验证 γ 权重数据加载是否正确
- **分布图生成**：验证 γ 权重分布图表是否正确生成
- **趋势图生成**：验证 γ 权重趋势图表是否正确生成
- **权重对比**：验证权重对比表数据是否正确
- **差异计算**：验证不同客户端间的权重差异计算是否准确

### 9.2 异常测试

- **数据缺失**：测试 γ 权重数据缺失时的错误处理
- **数据格式错误**：测试 γ 权重数据格式错误时的处理
- **参数错误**：测试无效轮次的处理

### 9.3 性能测试

- **数据加载性能**：测试不同大小 γ 权重数据的加载时间
- **图表渲染性能**：测试不同数量客户端的图表渲染时间
- **响应性能**：测试用户操作的响应时间

## 10. 版本控制

| 版本 | 日期 | 作者 | 变更内容 |
|------|------|------|----------|
| v1.0 | 2026-02-13 | 系统架构师 | 初始版本 |