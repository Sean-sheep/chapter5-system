# 综合对比页面 SPEC 文档

## 1. 页面功能描述

### 1.1 核心功能

- **多城市推荐对比**：对比同一用户在不同城市的推荐结果差异
- **指标对比分析**：对比不同城市的评估指标（如 HR@K、NDCG@K、RMSE）
- **推荐差异可视化**：使用热力图等方式可视化展示推荐差异
- **综合性能分析**：提供综合性能分析和结论

### 1.2 辅助功能

- **数据导出**：支持导出对比结果为CSV格式
- **图表交互**：支持图表缩放、数据点悬停查看详情

## 2. 交互流程

### 2.1 页面加载流程

1. **初始化**：页面加载时，初始化综合对比服务和数据状态
2. **参数设置**：显示默认参数设置（城市选择、用户ID、训练轮次）
3. **状态检查**：检查模型文件和评估指标数据是否存在

### 2.2 对比分析流程

1. **参数配置**：用户选择多个城市、输入用户ID、选择训练轮次
2. **提交请求**：用户点击"生成对比"按钮
3. **数据处理**：系统加载模型和评估指标数据
4. **推荐生成**：为每个选择的城市生成推荐结果
5. **指标计算**：计算或加载各城市的评估指标
6. **差异分析**：分析不同城市推荐结果的差异
7. **结果展示**：显示推荐差异热力图、指标对比表和综合分析

## 3. 数据字段定义

### 3.1 输入数据

| 字段名 | 类型 | 描述 | 来源 |
|--------|------|------|------|
| `cities` | list | 选择的城市列表 | 用户输入 |
| `user_id` | int | 用户ID | 用户输入 |
| `round` | int | 训练轮次 | 用户输入 |
| `top_k` | int | 推荐商品数量 | 用户输入 |

### 3.2 输出数据

| 字段名 | 类型 | 描述 | 用途 |
|--------|------|------|------|
| `comparison_results` | dict | 多城市推荐对比结果 | 生成热力图和对比表 |
| `metrics_comparison` | pd.DataFrame | 指标对比数据 | 展示评估指标差异 |
| `difference_heatmap` | plotly.Figure | 推荐差异热力图 | 可视化推荐差异 |
| `analysis_summary` | string | 综合分析摘要 | 提供分析结论 |

### 3.3 对比结果数据结构

```json
{
  "cities": ["Tokyo", "Osaka", "Nagoya"],
  "recommendations": {
    "Tokyo": [
      {"item_id": "12345", "score": 0.95},
      {"item_id": "67890", "score": 0.88}
    ],
    "Osaka": [
      {"item_id": "24680", "score": 0.92},
      {"item_id": "13579", "score": 0.85}
    ],
    "Nagoya": [
      {"item_id": "98765", "score": 0.90},
      {"item_id": "54321", "score": 0.82}
    ]
  },
  "metrics": {
    "Tokyo": {"hr@10": 0.85, "ndcg@10": 0.78, "rmse": 0.12},
    "Osaka": {"hr@10": 0.82, "ndcg@10": 0.75, "rmse": 0.13},
    "Nagoya": {"hr@10": 0.80, "ndcg@10": 0.73, "rmse": 0.14}
  }
}
```

## 4. 接口调用规范

### 4.1 内部接口

| 接口名 | 参数 | 返回值 | 功能描述 | 调用时机 |
|--------|------|--------|----------|----------|
| `RecommendationService.compare_recommendations` | `cities: list, user_id: int, top_k: int, round: int` | `dict` | 多城市推荐对比 | 点击"生成对比"按钮 |
| `ModelLoader.load_metrics` | `client_id: int = None, round: int = None` | `pd.DataFrame` | 加载评估指标数据 | 指标对比时 |
| `PersonalizationWeightAnalyzer.compare_gamma` | `client_ids: list, round: int = None` | `pd.DataFrame` | 对比多个客户端的 γ 权重 | 综合分析时 |

### 4.2 外部依赖

| 依赖项 | 类型 | 用途 | 调用时机 |
|--------|------|------|----------|
| `models/` 目录 | 目录 | 存储模型文件 | 推荐生成时 |
| `metrics/` 目录 | 目录 | 存储评估指标数据 | 指标对比时 |
| `city_client_map.json` | 配置文件 | 城市-客户端映射 | 推荐服务初始化 |

## 5. 异常处理机制

### 5.1 异常类型

| 异常类型 | 描述 | 处理方式 |
|----------|------|----------|
| **模型文件缺失** | 对应城市的模型文件不存在 | 显示错误信息，提示用户检查模型文件 |
| **指标数据缺失** | 评估指标数据不存在 | 显示警告信息，仅展示推荐对比 |
| **参数错误** | 用户输入参数无效（如城市不存在） | 显示警告信息，提示用户修正参数 |
| **对比城市过多** | 用户选择的对比城市数量超过限制 | 显示警告信息，限制最大对比城市数 |
| **推理失败** | 模型推理过程中出现错误 | 显示错误信息，记录错误日志 |

### 5.2 错误提示

- **模型文件缺失**：`st.error("模型文件不存在，请检查 data/models/ 目录")`
- **指标数据缺失**：`st.warning("评估指标数据不存在，仅展示推荐对比")`
- **参数错误**：`st.warning("无效的参数，请检查输入")`
- **对比城市过多**：`st.warning("对比城市数量过多，最多支持3个城市")`
- **推理失败**：`st.error("推荐生成失败，请检查模型文件")`

## 6. 性能要求

### 6.1 加载性能

- **页面加载时间**：≤ 3秒
- **模型加载时间**：≤ 2秒（每个城市）

### 6.2 交互性能

- **对比生成时间**：≤ 3秒（3个城市）
- **图表渲染时间**：≤ 1秒
- **响应时间**：用户操作后，≤ 0.5秒内显示反馈

### 6.3 资源使用

- **内存使用**：≤ 250MB
- **CPU 使用率**：≤ 25%（对比生成时）

## 7. 页面布局与组件

### 7.1 布局结构

- **侧边栏**：参数配置区（城市选择、用户ID、训练轮次、Top-K、生成对比按钮）
- **主区**：
  - 推荐差异热力图区
  - 指标对比表区
  - 推荐结果对比区
  - 综合分析区
  - 导出按钮区

### 7.2 核心组件

| 组件名 | 类型 | 描述 | 位置 |
|--------|------|------|------|
| `st.sidebar.multiselect` | 多选组件 | 城市选择 | 侧边栏 |
| `st.sidebar.number_input` | 输入组件 | 用户ID输入 | 侧边栏 |
| `st.sidebar.selectbox` | 选择组件 | 训练轮次选择 | 侧边栏 |
| `st.sidebar.selectbox` | 选择组件 | Top-K选择 | 侧边栏 |
| `st.sidebar.button` | 按钮组件 | 生成对比按钮 | 侧边栏 |
| `st.plotly_chart` | 图表组件 | 推荐差异热力图 | 主区顶部 |
| `st.dataframe` | 表格组件 | 指标对比表 | 主区中部 |
| `st.dataframe` | 表格组件 | 推荐结果对比表 | 主区中部 |
| `st.markdown` | 文本组件 | 综合分析 | 主区底部 |
| `st.download_button` | 按钮组件 | 导出数据按钮 | 主区底部 |

### 7.3 组件配置

- **城市选择**：`st.sidebar.multiselect("选择对比城市", ["Tokyo", "Osaka", "Nagoya"])`
- **用户ID**：`st.sidebar.number_input("用户ID", min_value=0, max_value=99999, value=123)`
- **训练轮次**：`st.sidebar.selectbox("训练轮次", ["最新"] + available_rounds)`
- **Top-K**：`st.sidebar.selectbox("Top-K", [5, 10, 20])`
- **推荐差异热力图**：`st.plotly_chart(difference_heatmap, use_container_width=True)`
- **指标对比表**：`st.dataframe(metrics_comparison, use_container_width=True)`

## 8. 实现注意事项

### 8.1 模型管理

- **缓存机制**：实现模型缓存，避免重复加载同一模型
- **批量处理**：多城市对比时，使用批量处理减少重复计算

### 8.2 性能优化

- **异步加载**：使用异步加载模型，避免阻塞UI线程
- **并行处理**：多城市推荐生成时，使用并行处理提高速度

### 8.3 可视化设计

- **热力图配置**：优化热力图配置，确保差异可视化清晰
- **对比表格**：设计清晰的对比表格，便于用户快速识别差异
- **综合分析**：提供有洞察力的综合分析，帮助用户理解结果

## 9. 测试要点

### 9.1 功能测试

- **多城市推荐对比**：验证不同城市的推荐结果是否正确生成和对比
- **指标对比分析**：验证评估指标对比是否准确
- **推荐差异可视化**：验证推荐差异热力图是否正确生成
- **综合分析**：验证综合性能分析是否合理

### 9.2 异常测试

- **模型缺失**：测试模型文件缺失时的错误处理
- **指标数据缺失**：测试评估指标数据缺失时的处理
- **参数错误**：测试无效参数输入时的错误处理
- **对比城市过多**：测试选择过多城市时的处理

### 9.3 性能测试

- **对比生成时间**：测试不同数量城市的对比生成时间
- **响应性能**：测试用户操作的响应时间
- **内存使用**：测试系统内存使用情况

## 10. 版本控制

| 版本 | 日期 | 作者 | 变更内容 |
|------|------|------|----------|
| v1.0 | 2026-02-13 | 系统架构师 | 初始版本 |