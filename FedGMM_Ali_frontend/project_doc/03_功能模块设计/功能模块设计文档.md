# 功能模块设计文档

## 1. 模块概述

系统共设计 5 个核心功能模块，模块间通过接口交互，松耦合设计。

```
├── 模块1：模型加载器（ModelLoader）
├── 模块2：推荐推理接口（RecommendationService）
├── 模块3：通信分析模块（CommunicationAnalyzer）
├── 模块4：自适应迭代次数展示模块（AdaptiveIterationVisualizer）
└── 模块5：个性化权重分析模块（PersonalizationWeightAnalyzer）
```

---

## 2. 模块1：模型加载器（ModelLoader）

### 职责
- 从指定目录加载训练结果；支持 JSON/PKL/NPY/CSV；提供统一模型访问接口；缓存已加载模型

### 核心功能与接口
- **load_sub_models()** → List[Dict]：加载所有全局子模型参数
- **load_client_model(client_id, round=None)** → Dict：加载指定客户端个性化模型
- **load_client_gamma(client_id, round=None)** → Dict[str, float]：加载客户端混合权重 γ
- **get_personalized_model(client_id, round=None)** → Dict：组合子模型与 γ 得到个性化模型
- **get_available_rounds()** → List[int]
- **get_available_clients()** → List[int]

### 实现要点
- 文件格式：PKL（pickle/joblib）、JSON、NPY、CSV
- 缓存：按 client_id + round 缓存，避免重复 IO
- 错误处理：文件不存在返回 None 或明确异常；格式错误记日志

---

## 3. 模块2：推荐推理接口（RecommendationService）

### 职责
- 接收城市/客户端ID、用户ID；执行推荐推理（仅前向）；返回 Top-K 推荐列表

### 核心功能与接口
- **get_client_id_by_city(city)** → int：城市→客户端ID 映射
- **recommend(city, user_id, top_k=10)** → List[Tuple[int, float]]：单城市 Top-K 推荐
- **compare_recommendations(cities, user_id, top_k)** → Dict[str, List]：多城市推荐对比
- **format_recommendation_result(recommendations, item_info)** → List[Dict]：格式化结果（排名、商品ID、名称、评分）

### 实现要点
- 前向推理：根据模型类型（矩阵分解/神经网络）实现；矩阵分解为 user_emb @ item_emb
- 城市映射表：如 CITY_CLIENT_MAPPING = {"Tokyo": 0, "Osaka": 1, "Nagoya": 2}

---

## 4. 模块3：通信分析模块（CommunicationAnalyzer）

### 职责
- 计算每轮通信量、压缩比例；生成通信统计报告；输出曲线数据供可视化

### 核心功能与接口
- **load_communication_stats()** → Dict：读取通信统计（如 round_0: {original_size, compressed_size, compression_ratio}）
- **calculate_compression_ratio(round=None)** → float：指定轮次或平均压缩比例
- **get_compression_curve_data()** → Dict[str, List]：rounds, compression_ratios, original_sizes, compressed_sizes
- **generate_communication_report()** → Dict：total_rounds, avg_compression_ratio, total_saved, saving_percentage 等
- **get_communication_by_client(client_id)** → Dict（可选）

### 数据格式约定
- 通信统计可为 JSON：round_i: {original_size, compressed_size, compression_ratio, compression_method, k_value}

---

## 5. 模块4：自适应迭代次数展示模块（AdaptiveIterationVisualizer）

### 职责
- 读取 τ* 轨迹；生成 τ* 变化曲线；对比不同客户端；分析自适应策略效果

### 核心功能与接口
- **load_tau_star_trajectory(client_id=None)** → Dict：如 client_0: [5,6,5,7,...]
- **get_tau_star_curve_data(client_ids=None)** → Dict[str, List]：rounds + 各 client 的 τ* 序列
- **analyze_adaptive_strategy()** → Dict：avg_iterations, std_iterations, min/max, adaptation_frequency, convergence_trend
- **get_tau_star_statistics(client_id=None)** → Dict

### 数据格式约定
- τ* 轨迹可为 JSON：client_i: [tau_round0, tau_round1, ...] 或按 round/client 的 CSV

---

## 6. 模块5：个性化权重分析模块（PersonalizationWeightAnalyzer）

### 职责
- 展示 γ 分布；对比不同城市权重差异；分析权重随轮次变化趋势

### 核心功能与接口
- **load_all_gammas(round=None)** → Dict[int, Dict[str, float]]：client_id → 子模型权重
- **get_gamma_distribution_data(round=None)** → Dict：client_ids, cities, sub_model_0, sub_model_1, ...
- **compare_city_weights(cities, round=None)** → Dict[str, Dict[str, float]]
- **analyze_weight_trend(client_id, sub_model)** → Dict[str, List]：rounds, weights
- **calculate_weight_difference(city1, city2, round=None)** → float：L2 距离

### 实现要点
- 权重归一化校验：sum(γ) ≈ 1
- 权重差异：同一子模型顺序下求向量 L2 距离

---

## 7. 模块间交互

- **依赖**：RecommendationService、PersonalizationWeightAnalyzer 依赖 ModelLoader；CommunicationAnalyzer、AdaptiveIterationVisualizer 独立读文件
- **数据流**：用户请求 → 前端 → 业务/分析模块 → ModelLoader 或文件系统

---

## 8. 实现优先级

- **第一阶段**：ModelLoader、RecommendationService
- **第二阶段**：CommunicationAnalyzer、AdaptiveIterationVisualizer、PersonalizationWeightAnalyzer

---

## 9. 测试策略

- **单元测试**：各模块接口与边界情况
- **集成测试**：模块间调用与端到端流程
- **数据验证**：训练结果格式与完整性检查
