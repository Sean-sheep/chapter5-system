# 角色与功能设计文档

## 1. 系统角色定义

### 1.1 角色概述

本系统为**展示型平台**，采用**单角色**设计，所有使用者权限一致，无需登录与权限区分。

### 1.2 用户角色：展示用户（Viewer）

- **描述**：系统的主要使用者，用于查看训练结果与推荐效果
- **权限**：查看推荐结果、通信压缩分析、自适应迭代分析、个性化权重分析、综合对比、导出数据与图表
- **特点**：只读、无用户管理、无权限控制

---

## 2. 功能模块与页面总览

```
功能模块：
├── 模块1：模型加载器（ModelLoader）
├── 模块2：推荐推理接口（RecommendationService）
├── 模块3：通信分析模块（CommunicationAnalyzer）
├── 模块4：自适应迭代次数展示模块（AdaptiveIterationVisualizer）
└── 模块5：个性化权重分析模块（PersonalizationWeightAnalyzer）

展示页面：
├── 页面1：系统首页（Home）
├── 页面2：推荐展示页面（Recommendation）
├── 页面3：通信压缩分析页面（Communication）
├── 页面4：自适应迭代分析页面（Adaptive Iteration）
├── 页面5：个性化权重分析页面（Personalization）
└── 页面6：综合对比页面（Comparison）
```

---

## 3. 功能模块核心功能点摘要

### 3.1 模型加载器（ModelLoader）

| 编号 | 功能名称         | 说明 |
|------|------------------|------|
| F1.1 | 加载全局子模型   | 从文件加载所有子模型参数 |
| F1.2 | 加载客户端模型   | 按 client_id、round 加载个性化模型 |
| F1.3 | 加载混合权重 γ   | 按 client_id、round 加载 γ |
| F1.4 | 获取个性化模型   | 组合子模型与 γ 生成个性化模型 |
| F1.5 | 获取可用轮次     | 返回可用训练轮次列表 |
| F1.6 | 获取可用客户端   | 返回可用客户端 ID 列表 |
| F1.7 | 缓存管理         | 缓存已加载模型，提高访问效率 |

### 3.2 推荐推理接口（RecommendationService）

| 编号 | 功能名称         | 说明 |
|------|------------------|------|
| F2.1 | 城市到客户端映射 | 根据城市名称返回客户端 ID |
| F2.2 | 单城市推荐       | 按城市、用户 ID、Top-K 返回推荐列表 |
| F2.3 | 多城市推荐对比   | 多城市同一用户推荐结果对比 |
| F2.4 | 推荐结果格式化   | 添加排名、商品名称、评分等 |
| F2.5 | 前向推理         | 根据模型类型执行前向计算 |

### 3.3 通信分析模块（CommunicationAnalyzer）

| 编号 | 功能名称           | 说明 |
|------|--------------------|------|
| F3.1 | 加载通信统计       | 从文件读取每轮/每客户端通信统计 |
| F3.2 | 计算压缩比例       | 指定轮次或平均压缩比例 |
| F3.3 | 生成压缩曲线数据   | 供折线图使用的 rounds、ratios 等 |
| F3.4 | 生成通信报告       | 总轮次、平均压缩比例、节省量等 |
| F3.5 | 按客户端查询       | 指定客户端的通信统计（可选） |

### 3.4 自适应迭代展示模块（AdaptiveIterationVisualizer）

| 编号 | 功能名称           | 说明 |
|------|--------------------|------|
| F4.1 | 加载 τ* 轨迹       | 按客户端或全部加载 τ* 序列 |
| F4.2 | 生成 τ* 曲线数据   | 多客户端 τ* 随轮次数据 |
| F4.3 | 分析自适应策略     | 平均 τ*、标准差、调整频率等 |
| F4.4 | 获取 τ* 统计       | 指定客户端的 τ* 统计（可选） |

### 3.5 个性化权重分析模块（PersonalizationWeightAnalyzer）

| 编号 | 功能名称           | 说明 |
|------|--------------------|------|
| F5.1 | 加载所有权重       | 按轮次加载所有客户端 γ |
| F5.2 | 生成权重分布数据   | 供柱状图使用的 client_ids、cities、各子模型权重 |
| F5.3 | 对比城市权重       | 多城市 γ 对比 |
| F5.4 | 分析权重趋势       | 指定客户端、子模型的 γ 随轮次变化 |
| F5.5 | 计算权重差异       | 两城市 γ 的 L2 距离 |

---

## 4. 页面设计概要

### 4.1 系统首页（Home）

- 系统标题与简介；主要功能入口（推荐展示、通信分析、权重分析等）；系统状态（数据是否加载、可用城市、可用轮次）；快速开始说明。

### 4.2 推荐展示页面（Recommendation）

- **侧边栏**：城市选择、用户 ID、Top-K、训练轮次（最新/指定）
- **主区**：生成推荐按钮；推荐结果表格（排名、商品 ID、名称、评分）；导出 CSV；多城市对比（多选城市、对比推荐结果）。

### 4.3 通信压缩分析页面（Communication）

- **侧边栏**：客户端选择、轮次范围
- **主区**：压缩比例随轮次折线图；通信统计表（轮次、原始/压缩后大小、压缩比例、节省量）；统计摘要（总轮次、平均压缩比例、总节省、节省百分比）；导出。

### 4.4 自适应迭代分析页面（Adaptive Iteration）

- **侧边栏**：多选客户端、轮次范围
- **主区**：τ* 随轮次折线图（多客户端）；统计指标（平均 τ*、标准差、最小/最大、自适应频率）；客户端对比表；导出。

### 4.5 个性化权重分析页面（Personalization）

- **侧边栏**：训练轮次、城市选择（全部/指定）
- **主区**：γ 权重分布柱状图（按城市、子模型分组）；权重对比表；可选：某城市某子模型 γ 随轮次趋势图；导出。

### 4.6 综合对比页面（Comparison）

- **侧边栏**：多选城市、用户 ID、训练轮次
- **主区**：多城市同一用户推荐差异（表格或热力图）；指标对比表（如 HR@K、NDCG@K、RMSE）；综合性能分析说明。

---

## 5. 角色与功能/页面映射

- 展示用户（Viewer）可访问全部上述页面与功能；仅读训练结果与模型，可导出数据与图表；无修改与删除权限。

---

## 6. 交互与规范

- **输入**：selectbox、number_input、multiselect、slider 等
- **展示**：dataframe、plotly_chart、metric、info/error/warning
- **反馈**：spinner 加载、success/error 提示；支持下载 CSV/图表
- **导航**：侧边栏或 Tab 区分「训练过程展示」与「用户推荐使用」及子页
