# 系统架构设计文档

## 1. 系统概述

### 1.1 系统定位
本系统是一个**展示型平台**，用于展示已完成训练的个性化联邦学习模型的成果。系统不参与模型训练，不修改训练代码，不实现算法逻辑，仅负责：
- 读取训练输出结果（模型参数、日志、统计指标）
- 展示个性化推荐效果
- 展示通信压缩效果
- 展示自适应本地迭代轨迹
- 展示客户端异质性分析

### 1.2 业务场景
**城市旅游消费个性化推荐系统**
- 模拟多个城市客户端（Tokyo / Osaka / Nagoya）
- 每个城市绑定一个客户端ID
- 支持选择城市 → 输出推荐商品列表
- 展示不同城市的个性化推荐差异

---

## 2. 四层架构设计

### 2.1 架构总览

```
┌─────────────────────────────────────────────────────────┐
│                   前端展示层                            │
│  (Streamlit / FastAPI + Vue)                           │
│  - 城市选择界面  - 推荐结果展示  - 指标可视化          │
└─────────────────────────────────────────────────────────┘
                          ↕
┌─────────────────────────────────────────────────────────┐
│                 可视化分析层                            │
│  - 通信压缩比例变化曲线  - τ* 自适应变化曲线           │
│  - 不同城市推荐差异  - γ 权重分布可视化                │
└─────────────────────────────────────────────────────────┘
                          ↕
┌─────────────────────────────────────────────────────────┐
│                 业务场景模拟层                          │
│  - 城市-客户端ID映射  - 推荐推理接口  - 个性化模型选择  │
└─────────────────────────────────────────────────────────┘
                          ↕
┌─────────────────────────────────────────────────────────┐
│                   模型结果层                            │
│  - 全局子模型参数  - 客户端个性化权重 γ                │
│  - 通信统计  - τ* 轨迹  - 评估指标（HR@K / NDCG@K）    │
└─────────────────────────────────────────────────────────┘
```

---

## 2.2 第一层：模型结果层（Data Layer）

- **职责**：从文件系统读取训练输出；解析 JSON/PKL/NPY/CSV；提供统一数据访问接口
- **数据来源结构**：训练输出目录下 models/、weights/、communication/、adaptive_iterations/、metrics/ 等
- **核心接口**：load_global_model、load_client_model、load_sub_models、load_client_gamma、load_communication_stats、load_tau_star_trajectory、load_metrics

---

## 2.3 第二层：业务场景模拟层（Business Layer）

- **职责**：模拟城市客户端；城市-客户端ID映射；推荐推理接口；个性化模型选择
- **城市-客户端映射**：如 Tokyo→0, Osaka→1, Nagoya→2
- **核心接口**：get_personalized_model、recommend、get_city_client_id、compare_recommendations

---

## 2.4 第三层：可视化分析层（Visualization Layer）

- **职责**：生成通信压缩曲线、τ* 轨迹图、γ 分布图、推荐差异对比图
- **核心接口**：plot_compression_ratio、plot_tau_star_trajectory、plot_gamma_distribution、plot_recommendation_difference、plot_metrics_comparison

---

## 2.5 第四层：前端展示层（Presentation Layer）

- **技术选型**：推荐 Streamlit（快速开发、Python 全栈）
- **主页面布局**：侧边栏（城市选择、用户ID、参数配置）+ 主内容区（推荐结果、指标、图表）
- **功能页面**：推荐展示、通信压缩分析、自适应迭代分析、个性化权重分析、综合对比

---

## 3. 数据流设计

- **推荐请求**：用户选择城市 → 业务层取客户端ID → 模型层加载个性化模型 → 业务层前向推理 → 前端展示结果
- **可视化请求**：用户选择类型 → 可视化层准备数据 → 模型层读取数据 → 可视化层生成图表 → 前端展示

---

## 4. 技术栈

- **后端**：Python 3.8+，Streamlit 或 FastAPI
- **数据处理**：pandas, numpy；**模型加载**：pickle, joblib；**可视化**：matplotlib, plotly
- **数据存储**：本地文件（JSON/PKL/NPY/CSV），无需数据库

---

## 5. 系统特点与部署

- **轻量级**：不涉及训练，无需 GPU/数据库
- **易扩展**：模块化、接口清晰
- **论文友好**：界面简洁，适合截图
- **本地部署**：`pip install streamlit pandas numpy matplotlib plotly` 后 `streamlit run app.py`
