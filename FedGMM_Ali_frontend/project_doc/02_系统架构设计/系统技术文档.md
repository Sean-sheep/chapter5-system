# 系统技术文档

## 1. 系统架构

### 1.1 架构概述

本系统采用前后端分离的架构设计，后端使用Flask框架实现API接口，前端使用HTML、CSS和JavaScript实现页面布局和交互逻辑。系统分为四层：前端展示层、可视化分析层、业务场景模拟层和模型结果层。

### 1.2 架构图

```
┌─────────────────────────────────────────────────────────┐
│                   前端展示层                            │
│  (HTML/CSS/JavaScript + Chart.js)                     │
│  - 城市选择界面  - 推荐结果展示  - 指标可视化          │
└─────────────────────────────────────────────────────────┘
                          ↕
┌─────────────────────────────────────────────────────────┐
│                 可视化分析层                            │
│  - 通信压缩比例变化曲线  - τ* 自适应变化曲线           │
│  - 不同城市推荐差异  - γ 权重分布可视化                │
└─────────────────────────────────────────────────────────┘
                          ↕
┌─────────────────────────────────────────────────────────┐
│                 业务场景模拟层                          │
│  - 城市-客户端ID映射  - 推荐推理接口  - 个性化模型选择  │
└─────────────────────────────────────────────────────────┘
                          ↕
┌─────────────────────────────────────────────────────────┐
│                   模型结果层                            │
│  - 全局子模型参数  - 客户端个性化权重 γ                │
│  - 通信统计  - τ* 轨迹  - 评估指标（HR@K / NDCG@K）    │
└─────────────────────────────────────────────────────────┘
```

### 1.3 技术栈

| 层级 | 技术 | 版本 | 用途 |
|------|------|------|------|
| 后端 | Python | 3.8+ | 实现API接口和业务逻辑 |
| 后端 | Flask | 2.0+ | Web框架，提供API接口 |
| 后端 | Flask-CORS | 3.0+ | 处理跨域请求 |
| 前端 | HTML5 | - | 页面结构 |
| 前端 | CSS3 | - | 页面样式 |
| 前端 | JavaScript | ES6+ | 交互逻辑 |
| 前端 | Chart.js | 3.0+ | 数据可视化 |

## 2. 后端API接口

### 2.1 系统状态接口

**接口路径**: `/api/system/status`

**请求方法**: GET

**功能描述**: 获取系统状态，包括数据加载状态、可用城市和可用训练轮次

**响应格式**:

```json
{
  "data_loaded": true,
  "available_cities": ["Tokyo", "Osaka", "Nagoya"],
  "available_rounds": [0, 1, 2, ..., 50],
  "system_status": "系统正常运行，所有数据已加载",
  "data_status": {
    "communication": true,
    "gamma": true,
    "tau": true,
    "models": true
  }
}
```

### 2.2 通信数据接口

**接口路径**: `/api/communication/data`

**请求方法**: GET

**功能描述**: 获取通信压缩数据，包括原始大小、压缩后大小、压缩比例等

**查询参数**:

| 参数名 | 类型 | 描述 | 可选值 |
|--------|------|------|--------|
| client_id | int | 客户端ID | 0, 1, 2 |
| start_round | int | 起始轮次 | 0-50 |
| end_round | int | 结束轮次 | 0-50 |

**响应格式**:

```json
{
  "data": [
    {
      "round": 0,
      "client_id": 0,
      "original_size": 1000000,
      "compressed_size": 400000,
      "compression_ratio": 0.4,
      "savings": 600000,
      "savings_percentage": 0.6
    },
    ...
  ],
  "statistics": {
    "total_rounds": 51,
    "total_clients": 3,
    "avg_compression": 0.35,
    "total_savings": 15000000,
    "savings_percentage": 0.65
  }
}
```

### 2.3 自适应迭代数据接口

**接口路径**: `/api/adaptive/data`

**请求方法**: GET

**功能描述**: 获取自适应迭代数据，包括τ*值、准确率和损失

**查询参数**:

| 参数名 | 类型 | 描述 | 可选值 |
|--------|------|------|--------|
| client_id | int | 客户端ID | 1, 2, 3, 4 |
| start_round | int | 起始轮次 | 1-10 |
| end_round | int | 结束轮次 | 1-10 |

**响应格式**:

```json
{
  "data": [
    {
      "round": 1,
      "client_id": 1,
      "tau_star": 5.0,
      "accuracy": 0.6,
      "loss": 1.2
    },
    ...
  ],
  "statistics": {
    "total_rounds": 10,
    "total_clients": 4,
    "average_tau_star": 8.5,
    "max_tau_star": 10.0,
    "min_tau_star": 5.0
  }
}
```

### 2.4 个性化权重数据接口

**接口路径**: `/api/personalization/data`

**请求方法**: GET

**功能描述**: 获取个性化权重数据，包括γ权重、个性化准确率和全局准确率

**查询参数**:

| 参数名 | 类型 | 描述 | 可选值 |
|--------|------|------|--------|
| client_id | int | 客户端ID | 1, 2, 3, 4 |
| round | int | 训练轮次 | 1-10 |

**响应格式**:

```json
{
  "data": [
    {
      "round": 10,
      "client_id": 1,
      "gamma": {
        "1": 0.3,
        "2": 0.4,
        "3": 0.3
      },
      "personalization_accuracy": 0.85,
      "global_accuracy": 0.8
    },
    ...
  ],
  "statistics": {
    "total_rounds": 10,
    "total_clients": 4,
    "average_personalization_accuracy": 0.88,
    "average_global_accuracy": 0.82
  }
}
```

### 2.5 推荐生成接口

**接口路径**: `/api/recommendation/generate`

**请求方法**: POST

**功能描述**: 生成个性化推荐结果

**请求体**:

```json
{
  "city": "北京",
  "user_id": 1,
  "top_k": 5,
  "round": 10
}
```

**响应格式**:

```json
{
  "recommendations": [
    {
      "rank": 1,
      "place_id": 1,
      "name": "故宫博物院",
      "category": "文化古迹",
      "score": 4.8,
      "price": "高",
      "popularity": 98
    },
    ...
  ],
  "city": "北京",
  "user_id": 1,
  "top_k": 5
}
```

### 2.6 多城市对比接口

**接口路径**: `/api/recommendation/compare`

**请求方法**: POST

**功能描述**: 生成多城市推荐对比结果

**请求体**:

```json
{
  "cities": ["北京", "上海"],
  "user_id": 1,
  "top_k": 5,
  "round": 10
}
```

**响应格式**:

```json
{
  "comparisons": [
    {
      "city": "北京",
      "recommendations": [
        {
          "rank": 1,
          "place_id": 1,
          "name": "故宫博物院",
          "category": "文化古迹",
          "score": 4.8,
          "price": "高",
          "popularity": 98
        },
        ...
      ]
    },
    {
      "city": "上海",
      "recommendations": [
        {
          "rank": 1,
          "place_id": 1,
          "name": "外滩",
          "category": "景点",
          "score": 4.7,
          "price": "低",
          "popularity": 96
        },
        ...
      ]
    }
  ],
  "user_id": 1,
  "top_k": 5
}
```

## 3. 前端实现

### 3.1 前端架构

前端采用模块化的架构设计，主要包括以下模块：

1. **Utils模块**: 提供通用工具函数，如API请求、数据格式化、CSV导出等
2. **DataLoader模块**: 负责加载各种数据，包括通信数据、自适应迭代数据、个性化权重数据和推荐数据
3. **ChartGenerator模块**: 负责生成各种图表，如压缩比例曲线、τ*趋势曲线、γ权重分布等

### 3.2 页面结构

前端包含以下页面：

1. **首页**: 系统介绍、快速入口、系统状态和快速开始说明
2. **通信压缩分析页面**: 通信压缩数据展示、压缩比例曲线和通信统计表
3. **自适应迭代分析页面**: 自适应迭代数据展示、τ*趋势曲线和准确率/损失曲线
4. **个性化权重分析页面**: 个性化权重数据展示、γ权重分布和γ权重趋势
5. **推荐展示页面**: 个性化推荐结果展示、推荐结果可视化和多城市对比
6. **综合对比页面**: 系统性能概览、训练轮次对比、客户端性能对比和创新点评估

### 3.3 数据可视化

前端使用Chart.js库实现数据可视化，主要包括以下图表类型：

1. **折线图**: 用于展示压缩比例变化、τ*趋势、准确率和损失变化等
2. **柱状图**: 用于展示γ权重分布、客户端性能对比等
3. **雷达图**: 用于展示多维度性能评估

## 4. 系统实现

### 4.1 后端实现

后端使用Flask框架实现API接口，主要包括以下模块：

1. **app.py**: 应用入口，注册蓝图和路由
2. **api/system.py**: 系统状态接口实现
3. **api/communication.py**: 通信数据接口实现
4. **api/adaptive.py**: 自适应迭代数据接口实现
5. **api/personalization.py**: 个性化权重数据接口实现
6. **api/recommendation.py**: 推荐生成接口实现

### 4.2 前端实现

前端使用HTML、CSS和JavaScript实现页面布局和交互逻辑，主要包括以下文件：

1. **index.html**: 系统首页
2. **css/style.css**: 全局样式
3. **js/main.js**: 主要JavaScript文件，包含通用工具函数和模块
4. **pages/communication/index.html**: 通信压缩分析页面
5. **pages/adaptive/index.html**: 自适应迭代分析页面
6. **pages/personalization/index.html**: 个性化权重分析页面
7. **pages/recommendation/index.html**: 推荐展示页面
8. **pages/comparison/index.html**: 综合对比页面

### 4.3 数据模型

系统使用以下数据模型：

1. **通信数据模型**: 包含轮次、客户端ID、原始大小、压缩后大小、压缩比例等字段
2. **自适应迭代数据模型**: 包含轮次、客户端ID、τ*值、准确率、损失等字段
3. **个性化权重数据模型**: 包含轮次、客户端ID、γ权重、个性化准确率、全局准确率等字段
4. **推荐数据模型**: 包含城市、用户ID、推荐列表等字段

## 5. 部署与运行

### 5.1 环境配置

1. **后端环境**:

   ```bash
   # 进入项目根目录
   cd FedGMM_Ali_frontend
   
   # 创建虚拟环境
   python -m venv venv
   
   # 激活虚拟环境
   # Windows: venv\Scripts\activate
   # Linux/Mac: source venv/bin/activate
   
   # 安装依赖
   pip install -r backend/requirements.txt
   
   # 运行后端服务
   cd backend
   python app.py
   ```

2. **前端环境**:

   前端无需特殊环境配置，直接在浏览器中打开 `frontend/index.html` 即可。

### 5.2 运行流程

1. **创建并激活虚拟环境**:
   - Windows: `venv\Scripts\activate`
   - Linux/Mac: `source venv/bin/activate`

2. **启动后端服务**:
   ```bash
   cd backend
   python app.py
   ```

3. **在浏览器中打开前端页面**:
   - 直接打开 `frontend/index.html` 文件
   - 或使用Python内置服务器访问: `python -m http.server 8000` 然后访问 `http://localhost:8000`

4. **选择相应的功能页面，配置参数，查看结果**

## 6. 技术亮点

1. **前后端分离架构**: 后端提供API接口，前端负责展示和交互，提高系统的可维护性和可扩展性
2. **模块化设计**: 前端和后端都采用模块化的设计，便于代码的维护和扩展
3. **数据可视化**: 使用Chart.js库实现丰富的数据可视化效果，直观展示系统性能和结果
4. **响应式布局**: 前端页面采用响应式布局，适配不同屏幕尺寸
5. **错误处理**: 系统包含完善的错误处理机制，提高系统的稳定性和用户体验

## 7. 总结

本系统实现了一个城市旅游消费个性化推荐系统，基于联邦学习和混合模型技术。系统分为两条主线：训练过程展示和用户推荐使用，旨在展示通信开销低、个性化推荐更精准、自适应本地迭代等创新点。

系统支持查看通信压缩效果、自适应迭代轨迹、个性化权重分布等训练过程数据，同时提供基于已训练模型的城市旅游消费推荐功能。通过前后端分离的架构设计和模块化的实现方式，系统具有良好的可维护性和可扩展性。