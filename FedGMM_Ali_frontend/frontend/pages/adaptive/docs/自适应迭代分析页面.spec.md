# 自适应迭代分析页面 SPEC 文档

## 1. 页面功能描述

### 1.1 核心功能

- **τ* 轨迹展示**：展示自适应本地迭代次数 τ* 随轮次的变化趋势
- **多客户端对比**：支持同时展示多个客户端的 τ* 轨迹
- **统计分析**：展示平均 τ*、标准差、最小/最大 τ*、自适应频率等统计指标
- **客户端对比表**：以表格形式展示不同客户端的 τ* 统计数据

### 1.2 辅助功能

- **数据导出**：支持导出 τ* 轨迹数据为CSV格式
- **图表交互**：支持图表缩放、数据点悬停查看详情

## 2. 交互流程

### 2.1 页面加载流程

1. **初始化**：页面加载时，初始化自适应迭代分析服务和数据状态
2. **参数设置**：显示默认参数设置（客户端选择、轮次范围）
3. **数据加载**：加载 τ* 轨迹数据，准备分析

### 2.2 数据分析流程

1. **参数配置**：用户选择多个客户端、设置轮次范围
2. **提交请求**：用户点击"刷新数据"按钮
3. **数据处理**：系统加载并处理 τ* 轨迹数据
4. **图表生成**：生成 τ* 随轮次变化的图表（多客户端）
5. **统计计算**：计算统计指标和客户端对比数据
6. **结果展示**：显示图表、统计指标和客户端对比表

## 3. 数据字段定义

### 3.1 输入数据

| 字段名 | 类型 | 描述 | 来源 |
|--------|------|------|------|
| `client_ids` | list | 选择的客户端列表 | 用户输入 |
| `round_range` | tuple | 轮次范围 (start, end) | 用户输入 |

### 3.2 输出数据

| 字段名 | 类型 | 描述 | 用途 |
|--------|------|------|------|
| `tau_star_data` | pd.DataFrame | τ* 轨迹数据 | 生成图表和对比表 |
| `statistics` | dict | 统计指标 | 展示关键指标 |
| `client_comparison` | pd.DataFrame | 客户端对比数据 | 展示客户端差异 |
| `chart` | plotly.Figure | τ* 轨迹图表 | 可视化展示 |

### 3.3 τ* 轨迹数据结构

```json
{
  "round": 1,
  "client_id": 0,
  "tau_star": 5
}
```

## 4. 接口调用规范

### 4.1 内部接口

| 接口名 | 参数 | 返回值 | 功能描述 | 调用时机 |
|--------|------|--------|----------|----------|
| `AdaptiveIterationVisualizer.load_tau_star_data` | `client_ids: list = None, round_range: tuple = None` | `pd.DataFrame` | 加载 τ* 数据 | 页面初始化 |
| `AdaptiveIterationVisualizer.plot_tau_star_trajectory` | `client_ids: list = None, round_range: tuple = None` | `plotly.Figure` | 生成 τ* 轨迹图表 | 数据加载后 |
| `AdaptiveIterationVisualizer.analyze_adaptive_strategy` | `client_ids: list = None, round_range: tuple = None` | `dict` | 分析自适应策略 | 数据加载后 |
| `ModelLoader.load_tau_star_trajectory` | `client_id: int = None, round_range: tuple = None` | `pd.DataFrame` | 加载 τ* 轨迹数据 | 页面初始化 |

### 4.2 外部依赖

| 依赖项 | 类型 | 用途 | 调用时机 |
|--------|------|------|----------|
| `tau_star/` 目录 | 目录 | 存储 τ* 轨迹数据 | 数据加载时 |
| `city_client_map.json` | 配置文件 | 城市-客户端映射 | 客户端名称显示 |

## 5. 异常处理机制

### 5.1 异常类型

| 异常类型 | 描述 | 处理方式 |
|----------|------|----------|
| **数据文件缺失** | τ* 轨迹数据文件不存在 | 显示错误信息，提示用户检查数据文件 |
| **数据格式错误** | τ* 轨迹数据格式错误 | 显示警告信息，尝试解析可用数据 |
| **参数错误** | 用户输入参数无效（如轮次范围错误） | 显示警告信息，提示用户修正参数 |
| **计算失败** | 统计计算过程中出现错误 | 显示错误信息，记录错误日志 |

### 5.2 错误提示

- **数据文件缺失**：`st.error("τ* 轨迹数据文件不存在，请检查 data/tau_star/ 目录")`
- **数据格式错误**：`st.warning("τ* 轨迹数据格式错误，尝试解析可用数据")`
- **参数错误**：`st.warning("无效的轮次范围，请检查输入")`
- **计算失败**：`st.error("统计计算失败，请检查数据文件")`

## 6. 性能要求

### 6.1 加载性能

- **页面加载时间**：≤ 3秒
- **数据加载时间**：≤ 2秒

### 6.2 交互性能

- **数据处理时间**：≤ 1秒（标准轮次范围）
- **图表渲染时间**：≤ 1秒
- **响应时间**：用户操作后，≤ 0.5秒内显示反馈

### 6.3 资源使用

- **内存使用**：≤ 150MB
- **CPU 使用率**：≤ 15%

## 7. 页面布局与组件

### 7.1 布局结构

- **侧边栏**：参数配置区（客户端选择、轮次范围、刷新数据按钮）
- **主区**：
  - τ* 轨迹图表区
  - 统计指标卡区
  - 客户端对比表区
  - 导出按钮区

### 7.2 核心组件

| 组件名 | 类型 | 描述 | 位置 |
|--------|------|------|------|
| `st.sidebar.multiselect` | 多选组件 | 客户端选择 | 侧边栏 |
| `st.sidebar.slider` | 滑块组件 | 轮次范围设置 | 侧边栏 |
| `st.sidebar.button` | 按钮组件 | 刷新数据按钮 | 侧边栏 |
| `st.plotly_chart` | 图表组件 | τ* 轨迹图表 | 主区顶部 |
| `st.columns` | 布局组件 | 统计指标卡 | 主区中部 |
| `st.dataframe` | 表格组件 | 客户端对比表 | 主区中部 |
| `st.download_button` | 按钮组件 | 导出数据按钮 | 主区底部 |

### 7.3 组件配置

- **客户端选择**：`st.sidebar.multiselect("选择客户端", ["Tokyo", "Osaka", "Nagoya"])`
- **轮次范围**：`st.sidebar.slider("轮次范围", 0, max_round, (0, max_round))`
- **τ* 轨迹图表**：`st.plotly_chart(chart, use_container_width=True)`
- **统计指标卡**：使用 `st.columns(5)` 创建五个指标卡
- **客户端对比表**：`st.dataframe(client_comparison, use_container_width=True, height=400)`

## 8. 实现注意事项

### 8.1 数据管理

- **缓存机制**：实现数据缓存，避免重复加载相同数据
- **数据验证**：验证数据格式和完整性，确保分析结果准确

### 8.2 性能优化

- **数据采样**：轮次范围较大时，使用数据采样减少计算量
- **异步处理**：使用异步处理数据，避免阻塞UI线程

### 8.3 图表设计

- **多线图表**：确保多客户端轨迹在同一图表中清晰可辨
- **图例设置**：合理设置图例，便于用户区分不同客户端
- **交互功能**：启用图表交互功能，提升用户体验

## 9. 测试要点

### 9.1 功能测试

- **数据加载**：验证 τ* 轨迹数据加载是否正确
- **图表生成**：验证 τ* 轨迹图表是否正确生成（多客户端）
- **统计计算**：验证统计指标计算是否准确
- **客户端对比**：验证客户端对比表数据是否正确
- **轮次范围**：验证不同轮次范围的分析结果是否正确

### 9.2 异常测试

- **数据缺失**：测试 τ* 轨迹数据缺失时的错误处理
- **数据格式错误**：测试 τ* 轨迹数据格式错误时的处理
- **参数错误**：测试无效轮次范围的处理

### 9.3 性能测试

- **数据加载性能**：测试不同大小 τ* 轨迹数据的加载时间
- **图表渲染性能**：测试不同数量客户端的图表渲染时间
- **响应性能**：测试用户操作的响应时间

## 10. 版本控制

| 版本 | 日期 | 作者 | 变更内容 |
|------|------|------|----------|
| v1.0 | 2026-02-13 | 系统架构师 | 初始版本 |