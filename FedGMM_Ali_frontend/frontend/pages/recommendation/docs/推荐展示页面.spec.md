# 推荐展示页面 SPEC 文档

## 1. 页面功能描述

### 1.1 核心功能

- **城市推荐**：根据用户选择的城市，生成个性化推荐商品列表
- **推荐参数配置**：支持配置用户ID、Top-K、训练轮次等参数
- **推荐结果展示**：以表格形式展示推荐结果，包含排名、商品ID、名称、评分等
- **多城市推荐对比**：支持选择多个城市，对比同一用户的推荐结果差异

### 1.2 辅助功能

- **结果导出**：支持导出推荐结果为CSV格式
- **推荐理由**：（可选）显示推荐理由或相似度分数

## 2. 交互流程

### 2.1 页面加载流程

1. **初始化**：页面加载时，初始化推荐服务和数据状态
2. **参数设置**：显示默认参数设置（城市、用户ID、Top-K、训练轮次）
3. **状态检查**：检查模型文件是否存在，确保推荐服务可用

### 2.2 推荐生成流程

1. **参数配置**：用户选择城市、输入用户ID、选择Top-K、选择训练轮次
2. **提交请求**：用户点击"生成推荐"按钮
3. **模型加载**：系统加载对应城市的个性化模型
4. **推理计算**：执行模型推理，生成推荐结果
5. **结果展示**：显示推荐结果表格，支持导出

### 2.3 多城市对比流程

1. **选择城市**：用户在多城市对比区域选择多个城市
2. **提交请求**：用户点击"对比推荐"按钮
3. **批量推理**：系统为每个选择的城市生成推荐结果
4. **结果对比**：以表格或并排列表形式展示多城市推荐结果对比

## 3. 数据字段定义

### 3.1 输入数据

| 字段名 | 类型 | 描述 | 来源 |
|--------|------|------|------|
| `city` | string | 选择的城市 | 用户输入 |
| `user_id` | int | 用户ID | 用户输入 |
| `top_k` | int | 推荐商品数量 | 用户输入 |
| `round` | int | 训练轮次 | 用户输入 |
| `compare_cities` | list | 对比城市列表 | 用户输入 |

### 3.2 输出数据

| 字段名 | 类型 | 描述 | 用途 |
|--------|------|------|------|
| `recommendations` | list | 推荐结果列表 | 展示推荐商品 |
| `comparison_results` | dict | 多城市对比结果 | 展示城市间推荐差异 |
| `recommendation_time` | float | 推荐生成时间 | 性能指标 |

### 3.3 推荐结果结构

```json
{
  "rank": 1,
  "item_id": "12345",
  "item_name": "东京塔门票",
  "score": 0.95
}
```

## 4. 接口调用规范

### 4.1 内部接口

| 接口名 | 参数 | 返回值 | 功能描述 | 调用时机 |
|--------|------|--------|----------|----------|
| `RecommendationService.recommend` | `city: str, user_id: int, top_k: int, round: int` | `pd.DataFrame` | 生成推荐结果 | 点击"生成推荐"按钮 |
| `RecommendationService.compare_recommendations` | `cities: list, user_id: int, top_k: int, round: int` | `pd.DataFrame` | 多城市推荐对比 | 点击"对比推荐"按钮 |
| `ModelLoader.get_available_rounds` | 无 | `list` | 获取可用训练轮次 | 页面加载时 |
| `ModelLoader.get_available_clients` | 无 | `list` | 获取可用客户端 | 页面加载时 |

### 4.2 外部依赖

| 依赖项 | 类型 | 用途 | 调用时机 |
|--------|------|------|----------|
| `models/` 目录 | 目录 | 存储模型文件 | 模型加载时 |
| `city_client_map.json` | 配置文件 | 城市-客户端映射 | 推荐服务初始化 |

## 5. 异常处理机制

### 5.1 异常类型

| 异常类型 | 描述 | 处理方式 |
|----------|------|----------|
| **模型文件缺失** | 对应城市的模型文件不存在 | 显示错误信息，提示用户检查模型文件 |
| **参数错误** | 用户输入参数无效（如城市不存在） | 显示警告信息，提示用户修正参数 |
| **推理失败** | 模型推理过程中出现错误 | 显示错误信息，记录错误日志 |
| **对比城市过多** | 用户选择的对比城市数量超过限制 | 显示警告信息，限制最大对比城市数 |

### 5.2 错误提示

- **模型文件缺失**：`st.error("模型文件不存在，请检查 data/models/ 目录")`
- **参数错误**：`st.warning("无效的参数，请检查输入")`
- **推理失败**：`st.error("推荐生成失败，请检查模型文件")`
- **对比城市过多**：`st.warning("对比城市数量过多，最多支持3个城市")`

## 6. 性能要求

### 6.1 加载性能

- **页面加载时间**：≤ 3秒
- **模型加载时间**：≤ 2秒

### 6.2 交互性能

- **推荐生成时间**：≤ 1秒（单城市）
- **多城市对比时间**：≤ 3秒（3个城市）
- **响应时间**：用户操作后，≤ 0.5秒内显示反馈

### 6.3 资源使用

- **内存使用**：≤ 200MB
- **CPU 使用率**：≤ 20%（推理时）

## 7. 页面布局与组件

### 7.1 布局结构

- **侧边栏**：参数配置区（城市选择、用户ID、Top-K、训练轮次、生成推荐按钮）
- **主区**：
  - 推荐结果展示区（表格、导出按钮）
  - 多城市对比区（城市选择、对比按钮、对比结果）

### 7.2 核心组件

| 组件名 | 类型 | 描述 | 位置 |
|--------|------|------|------|
| `st.sidebar.selectbox` | 选择组件 | 城市选择 | 侧边栏 |
| `st.sidebar.number_input` | 输入组件 | 用户ID输入 | 侧边栏 |
| `st.sidebar.selectbox` | 选择组件 | Top-K选择 | 侧边栏 |
| `st.sidebar.selectbox` | 选择组件 | 训练轮次选择 | 侧边栏 |
| `st.sidebar.button` | 按钮组件 | 生成推荐按钮 | 侧边栏 |
| `st.dataframe` | 表格组件 | 推荐结果表格 | 主区 |
| `st.download_button` | 按钮组件 | 导出CSV按钮 | 主区 |
| `st.multiselect` | 选择组件 | 对比城市选择 | 主区 |
| `st.button` | 按钮组件 | 对比推荐按钮 | 主区 |
| `st.spinner` | 加载组件 | 加载状态提示 | 主区 |

### 7.3 组件配置

- **城市选择**：`st.sidebar.selectbox("选择城市", ["Tokyo", "Osaka", "Nagoya"])`
- **用户ID**：`st.sidebar.number_input("用户ID", min_value=0, max_value=99999, value=123)`
- **Top-K**：`st.sidebar.selectbox("Top-K", [5, 10, 20])`
- **训练轮次**：`st.sidebar.selectbox("训练轮次", ["最新"] + available_rounds)`
- **推荐结果表格**：`st.dataframe(recommendations, use_container_width=True, height=400)`

## 8. 实现注意事项

### 8.1 模型管理

- **缓存机制**：实现模型缓存，避免重复加载同一模型
- **错误处理**：妥善处理模型加载失败的情况，提供明确的错误提示

### 8.2 性能优化

- **批量处理**：多城市对比时，使用批量处理减少重复计算
- **异步加载**：使用异步加载模型，避免阻塞UI线程

### 8.3 用户体验

- **加载提示**：推荐生成过程中显示加载动画，提升用户体验
- **结果排序**：确保推荐结果按评分降序排列，排名清晰
- **对比直观**：多城市对比结果以直观的方式展示，便于用户比较差异

## 9. 测试要点

### 9.1 功能测试

- **单城市推荐**：验证不同城市、不同用户ID、不同Top-K的推荐结果
- **多城市对比**：验证多城市推荐对比功能，确保结果正确
- **参数验证**：测试无效参数的处理，确保系统稳定性
- **导出功能**：验证推荐结果导出为CSV的功能

### 9.2 异常测试

- **模型缺失**：测试模型文件缺失时的错误处理
- **参数错误**：测试无效参数输入时的错误处理
- **推理失败**：测试推理过程中出现错误的处理

### 9.3 性能测试

- **推荐生成时间**：测试不同城市的推荐生成时间
- **多城市对比时间**：测试不同数量城市的对比时间
- **响应时间**：测试用户操作的响应时间

## 10. 版本控制

| 版本 | 日期 | 作者 | 变更内容 |
|------|------|------|----------|
| v1.0 | 2026-02-13 | 系统架构师 | 初始版本 |